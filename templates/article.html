{% extends "root.html" %}
{% block head %}
	<link href="/file/comment.css" rel="stylesheet" type="text/css">
	<meta property="og:title" content="{{ article.title }}"/>
	<meta property="og:type" content="article"/>
	<meta property="og:url" content="https://amandag.net/article/{{ article.id }}"/>
	<!-- TODO: Add image tag -->
	<meta property="og:description" content="{{ article.description() }}â€¦"/>
	<meta property="og:site_name" content="Amanda's blog"/>

	<meta property="article:author" content="{{ author_name }}">
	<meta property="article:published_time" content="{{ article.date.format("%Y-%m-%dT%H:%M:%SZ") }}">
	<!-- TODO: add categories -->

	<script>
		function auto_resize(element) {
			element.style.height = "auto";
			element.style.height = (element.scrollHeight + 10) + "px";
		}

		// Sends the form data to the JSON API point
		function send(form) {
			let data = new FormData(form);
			let request = new XMLHttpRequest();

			// Error handling
			request.onerror = function() {
				form.querySelector(".error").innerHTML = "An error happened: " + request.statusText;
			}

			// Success handling
			request.onload = function() {
				if (request.status == 200) {
					form.querySelector(".error").innerHTML = "Success";
				} else {
					form.querySelector(".error").innerHTML = "An error happened: "+request.statusText+": "+request.responseText;
				}
			}

			// Prepare the request
			request.open("POST", "/api/comments/submit");
			// Convert form data to object
			let object = {};
			data.forEach(function(value, key) {
				if (form.querySelector('[name="'+key+'"]').getAttribute("data-type") == "int") {
					value = parseInt(value);
				}
				if (form.querySelector('[name="'+key+'"]').getAttribute("data-type") == "bool") {
					if (value == "false") {
						value = false;
					}
					if (value == "true") {
						value = true;
					}
				}
				object[key] = value;
			})
			// Send data
			request.send(JSON.stringify(object));
		}

		function reply(elem) {
			let form = elem.closest("div.comment").querySelector("form.comment");
			form.style.display = "block";
		}

		function remove(id) {
			let request = new XMLHttpRequest();
			request.open("GET", "/api/comments/delete/" + id);
			request.send();
		}
	</script>
{% endblock %}

{% block content %}
	<article>
		<header>
			<h1>{{ article.title|escape }}</h1>
			<time title="{{ article.date.format("%c") }}" datetime="{{ article.date.format("%F %T") }}">
				{{ article.date.format("%d %b %Y - %H:%M") }}
			</time>
		</header>
		{{ article.content|escape }}
	</article>

	<form class="comment" onsubmit="send(this); return false;">
		<h1>Write a comment</h1>
		<input type="hidden" name="article" data-type="int" value="{{ article.id }}">
		<input type="hidden" name="visible" data-type="bool" value="true">
		<div class="error"></div>
		{% match session -%}
		{%- when Some with (session) -%}
			<input type="hidden" name="author" value="{{ session.user }}">
		{%- when None -%}
			<label>Name: <input type="text" name="name" required></label>
		{% endmatch %}
		<textarea name="content" oninput="auto_resize(this)"></textarea>
		<input type="submit" value="Submit">
	</form>

	{% for tree in comments %}
		{{ tree.render().unwrap() }}
	{% endfor %}
{% endblock %}
